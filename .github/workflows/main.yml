# name: Microservices Deployment

# on:
#   push:
#     branches: [ master ]

# jobs:
#   deploy-api-gateway:
#     runs-on: ubuntu-latest
#     steps:
#       # FIX 1: You MUST check out your repository code first
#       - name: Checkout Code
#         uses: actions/checkout@v4

     
#       - name: Set up JDK 21
#         uses: actions/setup-java@v3
#         with:
#           java-version: '21' 
#           distribution: 'temurin'
#           cache: maven

#       - name: Build Service One
#         # Maven will now find the pom.xml in the root directory
#         run: mvn clean install -DskipTests

#       - name: Deploy Service api-gateway to Azure
#         uses: azure/webapps-deploy@v3
#         with:
#           app-name: 'madhu-java-app'
#           publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
#           package: target/*.jar


name: Database Migration and Notify
on:
  push:
    branches: [ main ]

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run SQL Migrations
        run: |
          echo "Executing SQL/Alchemy migrations..."
          # Your actual migration commands go here

      - name: The Bridge - Trigger GitLab Pipeline
        if: success() # Only triggers if migrations pass
        run: |
          curl --request POST \
            --form token=${{ secrets.GITLAB_TRIGGER_TOKEN }} \
            --form ref=main \
            "https://gitlab.com/api/v4/projects/${{ secrets.GITLAB_PROJECT_ID }}/trigger/pipeline"
